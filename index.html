<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bildgalerie mit Zoom &amp; Video</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
      font-family: 'Roboto', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #1f2937 0%, #0f172a 100%);
      color: #f8fafc;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 2.5rem 1.5rem 1rem;
      text-align: center;
    }

    header h1 {
      margin: 0 0 0.5rem;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0;
      color: #cbd5f5;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1.5rem;
      padding: 0 1.5rem 2rem;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: 1fr;
      }

      .viewer {
        min-height: 50vh;
      }
    }

    .sidebar {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 1.25rem;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(12px);
    }

    .sidebar h2 {
      margin-top: 0;
      font-size: 1.1rem;
      letter-spacing: 0.02em;
    }

    .sidebar button, .sidebar .primary-btn {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.4rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      margin-bottom: 0.75rem;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      box-shadow: 0 12px 24px rgba(99, 102, 241, 0.35);
    }

    .sidebar button:hover,
    .sidebar .primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(99, 102, 241, 0.45);
    }

    .sidebar button.secondary {
      background: rgba(148, 163, 184, 0.25);
      box-shadow: none;
    }

    .sidebar button.secondary:hover {
      background: rgba(148, 163, 184, 0.35);
    }

    .image-list {
      flex: 1;
      overflow-y: auto;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .image-list li {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.8rem;
      border-radius: 0.9rem;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .image-list li.active {
      background: rgba(99, 102, 241, 0.3);
      transform: translateX(4px);
    }

    .image-list li:hover {
      background: rgba(148, 163, 184, 0.15);
    }

    .image-list img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 0.6rem;
    }

    .image-name {
      display: flex;
      flex-direction: column;
    }

    .image-name span {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .image-name small {
      font-size: 0.75rem;
      color: #cbd5f5;
    }

    .viewer {
      background: rgba(15, 23, 42, 0.65);
      border-radius: 1.5rem;
      position: relative;
      overflow: hidden;
      box-shadow: 0 35px 70px rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .viewer .panzoom {
      max-width: 100%;
      max-height: 100%;
      cursor: grab;
      user-select: none;
    }

    .viewer .panzoom:active {
      cursor: grabbing;
    }

    .status {
      text-align: center;
      color: #cbd5f5;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    .instructions {
      margin-top: 1.25rem;
      padding: 1rem;
      border-radius: 1rem;
      background: rgba(148, 163, 184, 0.12);
      color: #e2e8f0;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>Intelligente Bildgalerie</h1>
    <p>Lade deine Lieblingsbilder, entdecke sie mit Zoom &amp; Pan – und kreiere auf Knopfdruck ein animiertes Video.</p>
  </header>
  <main>
    <aside class="sidebar">
      <h2>Bilderverwaltung</h2>
      <button id="openFileDialog" class="primary-btn">Bilder auswählen</button>
      <button id="createVideoBtn" class="secondary">Video erstellen (Taste V)</button>
      <ul id="imageList" class="image-list"></ul>
      <p class="status" id="statusText">Keine Bilder geladen.</p>
      <div class="instructions">
        <strong>Tipps:</strong>
        <ul>
          <li>Klicke auf einen Listeneintrag, um das Bild im Viewer zu öffnen.</li>
          <li>Nutze Maus oder Trackpad zum Zoomen (Scrollrad) und Schieben (Drag).</li>
          <li>Drücke <kbd>V</kbd>, um ein dynamisches Video mit Zoom-Fahrten zu erzeugen.</li>
        </ul>
      </div>
    </aside>
    <section class="viewer" id="viewer">
      <img id="viewerImage" class="panzoom" alt="Aktuelles Bild" />
    </section>
  </main>

  <input type="file" id="fileInput" accept="image/*" multiple class="hidden" />

  <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@9.4.1/dist/panzoom.min.js"></script>
  <script>
    const STORAGE_KEY = 'smart-gallery-images';
    const fileInput = document.getElementById('fileInput');
    const openFileDialogButton = document.getElementById('openFileDialog');
    const createVideoButton = document.getElementById('createVideoBtn');
    const imageListElement = document.getElementById('imageList');
    const statusText = document.getElementById('statusText');
    const viewerImage = document.getElementById('viewerImage');
    const viewer = document.getElementById('viewer');

    let images = [];
    let currentIndex = -1;
    let panzoomInstance;

    function loadImagesFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        images = data ? JSON.parse(data) : [];
      } catch (error) {
        console.error('Fehler beim Laden der Bilddaten', error);
        images = [];
      }
      renderImageList();
    }

    function saveImagesToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(images));
    }

    function renderImageList() {
      imageListElement.innerHTML = '';
      if (!images.length) {
        statusText.textContent = 'Keine Bilder geladen.';
        viewerImage.src = '';
        viewerImage.classList.add('hidden');
        currentIndex = -1;
        return;
      }
      const fragment = document.createDocumentFragment();
      images.forEach((image, index) => {
        const listItem = document.createElement('li');
        if (index === currentIndex) {
          listItem.classList.add('active');
        }
        const thumb = document.createElement('img');
        thumb.src = image.dataUrl;
        thumb.alt = image.name;
        const nameContainer = document.createElement('div');
        nameContainer.classList.add('image-name');
        const nameSpan = document.createElement('span');
        nameSpan.textContent = image.name;
        const sizeInfo = document.createElement('small');
        sizeInfo.textContent = formatBytes(image.size);
        nameContainer.appendChild(nameSpan);
        nameContainer.appendChild(sizeInfo);
        listItem.appendChild(thumb);
        listItem.appendChild(nameContainer);
        listItem.addEventListener('click', () => selectImage(index));
        fragment.appendChild(listItem);
      });
      imageListElement.appendChild(fragment);
      statusText.textContent = `${images.length} Bild${images.length === 1 ? '' : 'er'} geladen.`;
      if (currentIndex === -1 && images.length) {
        selectImage(0);
      }
    }

    function selectImage(index) {
      currentIndex = index;
      const image = images[index];
      viewerImage.src = image.dataUrl;
      viewerImage.alt = image.name;
      viewerImage.classList.remove('hidden');
      if (panzoomInstance) {
        panzoomInstance.dispose();
      }
      panzoomInstance = Panzoom(viewerImage, {
        contain: 'outside',
        maxScale: 8,
        minScale: 0.5,
        step: 0.3,
      });
      viewerImage.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
      Array.from(imageListElement.children).forEach((child, idx) => {
        child.classList.toggle('active', idx === index);
      });
    }

    function formatBytes(bytes) {
      if (!bytes) return '';
      const units = ['B', 'KB', 'MB', 'GB'];
      const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
      const value = bytes / Math.pow(1024, exponent);
      return `${value.toFixed(1)} ${units[exponent]}`;
    }

    function readFiles(files) {
      const readers = Array.from(files).map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve({
          name: file.name,
          dataUrl: reader.result,
          size: file.size,
          type: file.type,
          lastModified: file.lastModified
        });
        reader.onerror = reject;
        reader.readAsDataURL(file);
      }));

      Promise.all(readers)
        .then(results => {
          images = [...images, ...results];
          saveImagesToStorage();
          renderImageList();
        })
        .catch(error => {
          console.error('Fehler beim Laden der Dateien', error);
          statusText.textContent = 'Beim Lesen der Dateien ist ein Fehler aufgetreten.';
        });
    }

    async function createVideoFromImages() {
      if (!images.length) {
        alert('Bitte lade zuerst mindestens ein Bild.');
        return;
      }

      statusText.textContent = 'Video wird erstellt – bitte warten...';

      const canvas = document.createElement('canvas');
      canvas.width = 1280;
      canvas.height = 720;
      const ctx = canvas.getContext('2d');
      const stream = canvas.captureStream(30);

      const mediaRecorder = new MediaRecorder(stream, {
        mimeType: 'video/webm; codecs=vp9'
      });

      const chunks = [];
      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) {
          chunks.push(event.data);
        }
      };

      const stopPromise = new Promise(resolve => {
        mediaRecorder.onstop = resolve;
      });

      mediaRecorder.start();

      const loadedImages = await Promise.all(images.map(image => loadImage(image.dataUrl)));
      const framesPerImage = 120; // 4 Sekunden bei 30 FPS
      const waitNextFrame = () => new Promise(resolve => requestAnimationFrame(resolve));

      for (const img of loadedImages) {
        for (let frame = 0; frame < framesPerImage; frame++) {
          const progress = frame / (framesPerImage - 1);
          drawAnimatedImage(ctx, img, canvas, progress);
          await waitNextFrame();
        }
      }

      mediaRecorder.stop();
      await stopPromise;

      const blob = new Blob(chunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'smart-gallery.webm';
      link.textContent = 'Video herunterladen';
      link.style.display = 'block';
      link.style.marginTop = '0.75rem';

      statusText.innerHTML = '';
      statusText.appendChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 60_000);
    }

    function drawAnimatedImage(ctx, img, canvas, progress) {
      ctx.fillStyle = '#0f172a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const imgAspect = img.width / img.height;
      const canvasAspect = canvas.width / canvas.height;

      let drawWidth;
      let drawHeight;

      if (imgAspect > canvasAspect) {
        drawWidth = canvas.width;
        drawHeight = canvas.width / imgAspect;
      } else {
        drawHeight = canvas.height;
        drawWidth = canvas.height * imgAspect;
      }

      const zoomFactor = 1 + 0.25 * Math.sin(progress * Math.PI * 2);
      const scaledWidth = drawWidth * zoomFactor;
      const scaledHeight = drawHeight * zoomFactor;

      const offsetX = (canvas.width - scaledWidth) / 2;
      const offsetY = (canvas.height - scaledHeight) / 2;

      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      const angle = Math.sin(progress * Math.PI * 2) * 0.02;
      ctx.rotate(angle);
      ctx.drawImage(
        img,
        -scaledWidth / 2,
        -scaledHeight / 2,
        scaledWidth,
        scaledHeight
      );
      ctx.restore();
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.onerror = reject;
        image.src = src;
      });
    }

    openFileDialogButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', event => {
      if (event.target.files?.length) {
        readFiles(event.target.files);
        fileInput.value = '';
      }
    });

    createVideoButton.addEventListener('click', createVideoFromImages);
    document.addEventListener('keydown', event => {
      if (event.key.toLowerCase() === 'v') {
        createVideoFromImages();
      }
    });

    loadImagesFromStorage();
  </script>
</body>
</html>
